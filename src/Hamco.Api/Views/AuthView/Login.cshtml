@{
    ViewBag.Title = "Login";
    ViewBag.Heading = "Login";
    ViewBag.Slogan = "Welcome back";
}

<div class="row gx-4 gx-lg-5 justify-content-center">
    <div class="col-md-10 col-lg-10 col-xl-8">
        <p>Please sign in to your account.</p>
        <div id="alertContainer"></div>

        <form id="loginForm">
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com" required>
                <label for="email">Email address</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                <label for="password">Password</label>
            </div>

            <div class="d-grid gap-2 mb-3">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span id="submitText">Sign In</span>
                    <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>

            <div class="text-center">
                <a href="/auth/forgot-password" class="text-decoration-none">Forgot password?</a>
            </div>
        </form>

        <hr class="my-4" />

        <div class="text-center">
            <p class="text-muted">Don't have an account? <a href="/auth/register">Register here</a></p>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const alertContainer = document.getElementById('alertContainer');
    const params = new URLSearchParams(window.location.search);
    if (params.get('verified') === '1') {
        alertContainer.innerHTML = '<div class="alert alert-success">Email verified. You can log in now.</div>';
    } else if (params.get('error')) {
        alertContainer.innerHTML = '<div class="alert alert-danger">Invalid or expired verification link.</div>';
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');

        submitBtn.disabled = true;
        submitText.classList.add('d-none');
        submitSpinner.classList.remove('d-none');

        try {
            const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await loginResponse.json();

            if (loginResponse.ok) {
                const cookieResponse = await fetch('/api/auth/cookie', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: data.token })
                });

                if (cookieResponse.ok) {
                    window.location.href = '/';
                    return;
                }

                alertContainer.innerHTML = '<div class="alert alert-danger">Login succeeded but cookie setup failed. Please try again.</div>';
            } else {
                alertContainer.innerHTML = `<div class="alert alert-danger">${data.message || 'Login failed.'}</div>`;
            }
        } catch {
            alertContainer.innerHTML = '<div class="alert alert-danger">Unable to connect to server. Please try again.</div>';
        }

        submitBtn.disabled = false;
        submitText.classList.remove('d-none');
        submitSpinner.classList.add('d-none');
    });
</script>
}
